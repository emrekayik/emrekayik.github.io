<div id="custom-context-menu" class="fixed
               bg-white rounded-md shadow-lg border border-gray-200 z-50
               invisible opacity-0 scale-95 pointer-events-none
               transition-all duration-200 ease-out">
    <ul class="py-1">
        <li>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-blue-500 hover:text-white"
                data-action="edit">
                Düzenle
            </a>
        </li>
        <li>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-red-500 hover:text-white"
                data-action="delete">
                Sil
            </a>
        </li>
        <li>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-200" data-action="copy">
                Kopyala
            </a>
        </li>
        <li>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-green-500 hover:text-white" data-action="share">
                Paylaş
            </a>
        </li>
        <hr class="my-1 border-gray-200"/>
        <li>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-200" data-action="info">
                Bilgi
            </a>
        </li>
    </ul>
</div>
<script>
    const contextMenu = document.getElementById('custom-context-menu');

    // Menüyü gizleyen fonksiyon
    function hideMenu() {
      // Animasyon sınıflarını ekleyerek gizle
      contextMenu.classList.add('opacity-0', 'scale-95', 'invisible', 'pointer-events-none');
      contextMenu.classList.remove('opacity-100', 'scale-100', 'visible', 'pointer-events-auto');
    }

    // Menüyü gösteren fonksiyon
    function showMenu(x, y) {
      // Menünün ekran dışına taşmasını engellemek için kontrol ekleyelim
      const menuWidth = contextMenu.offsetWidth;
      const menuHeight = contextMenu.offsetHeight;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;

      let finalX = x;
      let finalY = y;

      // Sağ kenardan taşarsa
      if (finalX + menuWidth > windowWidth) {
        finalX = windowWidth - menuWidth;
      }

      // Alt kenardan taşarsa
      if (finalY + menuHeight > windowHeight) {
        finalY = windowHeight - menuHeight;
      }

      // Sol veya üst kenardan taşarsa (çok nadir ama olabilir)
      finalX = Math.max(0, finalX);
      finalY = Math.max(0, finalY);


      contextMenu.style.left = finalX + 'px';
      contextMenu.style.top = finalY + 'px';

      // Animasyon sınıflarını kaldırarak göster
      contextMenu.classList.remove('opacity-0', 'scale-95', 'invisible', 'pointer-events-none');
      contextMenu.classList.add('opacity-100', 'scale-100', 'visible', 'pointer-events-auto'); // 'visible' sınıfı görünürlüğü ayarlar
    }


    // Sağ tık olayını sadece yazı (post) alanında dinle (yoksa belgeye düşer)
    const contextTarget = document.getElementById('post-content') || document.getElementById('content') || document;
    contextTarget.addEventListener('contextmenu', function (event) {
      // Varsayılan tarayıcı bağlam menüsünü engelle
      event.preventDefault();
      // Menüyü farenin olduğu yerde göster
      showMenu(event.clientX, event.clientY);
    });

    // Sayfadaki herhangi bir yere tıklandığında menüyü gizle
    document.addEventListener('click', function (event) {
      // Menü görünürse (visible sınıfı varsa) VE tıklanan yer menünün kendisi veya içindeki bir element değilse gizle
      const isMenuVisible = contextMenu.classList.contains('visible');

      if (isMenuVisible && !contextMenu.contains(event.target)) {
        hideMenu();
      }
    });

    // Kopyalama yardımcı fonksiyonu
    async function copyTextToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) { /* no-op */ }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Paylaşım yardımcı fonksiyonu
    async function shareCurrentPost() {
      const url = window.location.href.split('#')[0];
      const h1 = document.querySelector('#post-content h1') || document.querySelector('article h1') || document.querySelector('h1');
      const title = h1 ? h1.innerText.trim() : document.title;
      const selected = window.getSelection ? (window.getSelection().toString().trim()) : '';
      try {
        if (navigator.share) {
          await navigator.share({ title: title, text: selected || title, url: url });
          if (window.showToast) { window.showToast('Paylaşıldı.', 'success'); }
        } else {
          const ok = await copyTextToClipboard(url);
          if (ok) {
            if (window.showToast) { window.showToast('Bağlantı panoya kopyalandı.', 'success'); }
          } else {
            prompt('Bu bağlantıyı kopyalayın:', url);
            if (window.showToast) { window.showToast('Paylaşım desteklenmiyor. Bağlantıyı manuel kopyalayın.', 'warning', 4000); }
          }
        }
      } catch (err) {
        console.debug('Paylaşım iptal edildi veya başarısız:', err);
        if (window.showToast) { window.showToast('Paylaşım iptal edildi veya başarısız.', 'warning'); }
      }
    }

    // Menü içindeki öğelere tıklandığında (Event Delegation kullanarak)
    contextMenu.addEventListener('click', function (event) {
      const target = event.target; // Tıklanan elementi al
      // Tıklanan elementin veya üst elementlerinin 'a[data-action]' selector'üne uyup uymadığını kontrol et
      const menuItem = target.closest('a[data-action]');

      if (menuItem) {
        // Eğer bir menü öğesi bulunduysa
        event.preventDefault(); // a etiketinin varsayılan tıklama davranışını engelle

        const action = menuItem.getAttribute('data-action');
        console.log(`Seçilen Aksiyon: ${action}`); // Konsola yazdır veya istediğin işlemi yap

        if (action === 'edit') {
          console.log('Düzenleme işlemi başlatıldı.');
        } else if (action === 'delete') {
          console.log('Silme işlemi başlatıldı.');
        } else if (action === 'copy') {
          const selection = window.getSelection ? window.getSelection().toString().trim() : '';
          const textToCopy = selection || window.location.href.split('#')[0];
          copyTextToClipboard(textToCopy).then(function(ok){
            if (ok) {
              if (window.showToast) { window.showToast('Kopyalandı.', 'success'); }
            }
          });
        } else if (action === 'share') {
          shareCurrentPost();
        } else if (action === 'info') {
          console.log('Bilgi gösterme işlemi başlatıldı.');
        }

        // Aksiyon alındıktan sonra menüyü gizle
        hideMenu();
      }
      // Eğer tıklanan yer menünün içindeyse ama bir menü öğesi değilse (örneğin boş alan veya ayırıcı), menü gizlenmez.
      // Eğer menünün *herhangi* bir yerine tıklanınca gizlenmesini isterseniz, yukarıdaki `if (menuItem)` kontrolünü kaldırıp `hideMenu()` çağrısını doğrudan bu event listener'ın içine taşıyabilirsiniz.
      // Ancak genellikle sadece aksiyon seçildiğinde gizlenmesi beklenir. Dışarıya tıklama ise document listener tarafından zaten ele alınıyor.
    });


    // Sayfa kaydırıldığında menüyü gizle (UX için iyidir)
    window.addEventListener('scroll', function () {
      const isMenuVisible = contextMenu.classList.contains('visible');
      if (isMenuVisible) {
        hideMenu();
      }
    });

  </script>